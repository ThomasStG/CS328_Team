#include "Arduino.h"
#include "Speedometer.h"
#include <Wire.h>
#include <math.h>

//Set constructor with the OLED screen settings for the part
Speedometer::Speedometer(uint8_t address)
  : _address(address),
    _pointX(64),
    _pointY(64),
    _pointX1(0),
    _pointY1(0),
    _width(128),
    _height(64),
    _reset(-1),
    display(nullptr)
{}

void Speedometer::init() {
  display = new Adafruit_SSD1306(_width, _height, &Wire, _reset);
  display->begin(SSD1306_SWITCHCAPVCC, _address);
  display->clearDisplay();
  display->display();
}

//Set the gauge 
void Speedometer::buildGauge() {
  //gauge bitmap
  static const uint8_t halfCircle64x32[] PROGMEM = {
      0x00,0x00,0x0F,0xFF,0xFF,0xF0,0x00,0x00,
      0x00,0x00,0x3F,0xFF,0xFF,0xFC,0x00,0x00,
      0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
      0x00,0x01,0xFF,0xF0,0x0F,0xFF,0x80,0x00,
      0x00,0x07,0xFC,0x00,0x00,0x3F,0xE0,0x00,
      0x00,0x0F,0xE0,0x00,0x00,0x07,0xF0,0x00,
      0x00,0x1F,0x80,0x00,0x00,0x01,0xF8,0x00,
      0x00,0x3E,0x00,0x00,0x00,0x00,0x7C,0x00,
      0x00,0x7C,0x00,0x00,0x00,0x00,0x3E,0x00,
      0x00,0xF0,0x00,0x00,0x00,0x00,0x0F,0x00,
      0x01,0xE0,0x00,0x00,0x00,0x00,0x07,0x80,
      0x03,0xC0,0x00,0x00,0x00,0x00,0x03,0xC0,
      0x07,0x80,0x00,0x00,0x00,0x00,0x01,0xE0,
      0x07,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,
      0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x70,
      0x1C,0x00,0x00,0x00,0x00,0x00,0x00,0x38,
      0x38,0x00,0x00,0x00,0x00,0x00,0x00,0x1C,
      0x38,0x00,0x00,0x00,0x00,0x00,0x00,0x1C,
      0x70,0x00,0x00,0x00,0x00,0x00,0x00,0x0E,
      0x70,0x00,0x00,0x00,0x00,0x00,0x00,0x0E,
      0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
      0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
      0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x03,
      0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x03,
      0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x03,
      0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x01,
      0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x01,
      0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x01,
      0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x01,
      0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x01,
      0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x01,
      0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x01
  };
  display->setTextSize(1);
  display->setTextColor(SSD1306_WHITE);
  //Display meter numbers
  display->setCursor(0, 48);
  display->print("0");
  
  display->setCursor(96, 48);
  display->print("255");
  //Draw bitmap
  display->drawBitmap(32, 32, halfCircle64x32, 64, 32, SSD1306_WHITE);
  //display->setCursor(int16_t x, int16_t y)
}

void Speedometer::update(float MPH) {

  float angle = 180.0f - (MPH / 255.0f) * 180.0f;
  
  float rad = angle * PI / 180.0f;

  _pointX1 = _pointX + 28* cos(rad);

  _pointY1 = _pointY - 28* sin(rad);
  /*Serial.print("Point X: ");
  Serial.println(_pointX1);
  Serial.print("Point Y: ");
  Serial.println(_pointY1);*/
  display->clearDisplay();
  
  buildGauge();
  display->drawLine(_pointX, _pointY, _pointX1, _pointY1, SSD1306_WHITE);
  display->display();
}
//Clear the speedometer
void Speedometer::clear() {
  display->clearDisplay();
  display->display();
}