#include "Arduino.h"
#include "Accelerometer.h"
#include <Wire.h>
#include <math.h>

Accelerometer::Accelerometer(uint8_t address)
  : _address(address),
    _pointX(32),
    _pointY(32),
    _pointX1(0),
    _pointY1(0),
    _width(64),
    _height(32),
    _reset(-1),
    display(nullptr)
{}

void Accelerometer::init() {
  display = new Adafruit_SSD1306(_width, _height, &Wire, _reset);
  display->begin(SSD1306_SWITCHCAPVCC, _address);
  display->clearDisplay();
  display->display();
}

void Accelerometer::buildGauge() {
  display->setCursor(0, 0);
  static const uint8_t halfCircle64x32[] PROGMEM = {
      0x00,0x00,0x0F,0xFF,0xFF,0xF0,0x00,0x00,
      0x00,0x00,0x3F,0xFF,0xFF,0xFC,0x00,0x00,
      0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
      0x00,0x01,0xFF,0xF0,0x0F,0xFF,0x80,0x00,
      0x00,0x07,0xFC,0x00,0x00,0x3F,0xE0,0x00,
      0x00,0x0F,0xE0,0x00,0x00,0x07,0xF0,0x00,
      0x00,0x1F,0x80,0x00,0x00,0x01,0xF8,0x00,
      0x00,0x3E,0x00,0x00,0x00,0x00,0x7C,0x00,
      0x00,0x7C,0x00,0x00,0x00,0x00,0x3E,0x00,
      0x00,0xF0,0x00,0x00,0x00,0x00,0x0F,0x00,
      0x01,0xE0,0x00,0x00,0x00,0x00,0x07,0x80,
      0x03,0xC0,0x00,0x00,0x00,0x00,0x03,0xC0,
      0x07,0x80,0x00,0x00,0x00,0x00,0x01,0xE0,
      0x07,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,
      0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x70,
      0x1C,0x00,0x00,0x00,0x00,0x00,0x00,0x38,
      0x38,0x00,0x00,0x00,0x00,0x00,0x00,0x1C,
      0x38,0x00,0x00,0x00,0x00,0x00,0x00,0x1C,
      0x70,0x00,0x00,0x00,0x00,0x00,0x00,0x0E,
      0x70,0x00,0x00,0x00,0x00,0x00,0x00,0x0E,
      0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
      0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
      0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x03,
      0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x03,
      0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x03,
      0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x01,
      0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x01,
      0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x01,
      0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x01,
      0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x01,
      0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x01,
      0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x01
  };

  display->drawBitmap(0, 0, halfCircle64x32, 64, 32, SSD1306_WHITE);
}

void Accelerometer::update(int8_t RPM) {

  float angle = 180 - (RPM / 255.0) * 180;
  

  

  
  float rad = angle * PI / 180;

  _pointX1 = _pointX + 28* cos(rad);

  _pointY1 = _pointY + 28* sin(rad);
  display->clearDisplay();
  buildGauge();
  display->drawLine(_pointX, _pointY, _pointX1, _pointY1, SSD1306_WHITE);

  display->display();
}

void Accelerometer::clear() {
  display->clearDisplay();
  display->display();
}